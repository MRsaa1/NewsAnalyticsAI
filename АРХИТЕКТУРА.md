# 🏗️ Архитектура Signal Analysis

## 📊 Визуальная схема системы

```
┌─────────────────────────────────────────────────────────────────────┐
│                          ВНЕШНИЕ ИСТОЧНИКИ                          │
├─────────────────────────────────────────────────────────────────────┤
│  📰 RSS Feeds                    🤖 LLM APIs                        │
│  ├─ CryptoNews                   ├─ OpenAI GPT-4                    │
│  ├─ SEC.gov                      ├─ DeepSeek                        │
│  ├─ FDA.gov                      └─ xAI Grok                        │
│  ├─ Bloomberg                                                       │
│  └─ ...20+ фидов                                                    │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                   PYTHON BACKEND (FastAPI)                          │
│                          app.py (2441 строка)                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │  1️⃣  INGESTION LAYER (Сбор новостей)                      │   │
│  ├────────────────────────────────────────────────────────────┤   │
│  │  • Планировщик (APScheduler) - каждые 60 минут           │   │
│  │  • RSS Parser (feedparser) - парсинг фидов                │   │
│  │  • HTTP Client (httpx) - загрузка контента                │   │
│  │  • Дедупликация (SHA-256 hash)                            │   │
│  │  • Сохранение в таблицу: ingested                         │   │
│  └────────────────────────────────────────────────────────────┘   │
│                                ↓                                    │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │  2️⃣  ANALYSIS LAYER (Анализ через LLM)                    │   │
│  ├────────────────────────────────────────────────────────────┤   │
│  │  • Orphan Detection - поиск необработанных                │   │
│  │  • Batch Processing - пакетная обработка                  │   │
│  │  • LLM Call (async) - параллельный анализ                 │   │
│  │    ├─ Semaphore (limit=2) - ограничение                   │   │
│  │    ├─ Retry Logic (3 attempts) - повторы                  │   │
│  │    └─ Response Parsing - парсинг JSON                     │   │
│  │  • Extraction:                                             │   │
│  │    ├─ Sector (CRYPTO, TECH, ...)                          │   │
│  │    ├─ Tickers (BTC, TSLA, ...)                            │   │
│  │    ├─ Metrics (impact, confidence, sentiment)             │   │
│  │    ├─ Translations (EN → RU)                              │   │
│  │    └─ Deep Analysis                                        │   │
│  └────────────────────────────────────────────────────────────┘   │
│                                ↓                                    │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │  3️⃣  STORAGE LAYER (Сохранение)                           │   │
│  ├────────────────────────────────────────────────────────────┤   │
│  │  • SQLite Connection Pool                                  │   │
│  │  • WAL Mode (Write-Ahead Logging)                         │   │
│  │  • Transaction Management                                  │   │
│  │  • Сохранение в таблицу: signals                          │   │
│  └────────────────────────────────────────────────────────────┘   │
│                                ↓                                    │
│  ┌────────────────────────────────────────────────────────────┐   │
│  │  4️⃣  API LAYER (REST Endpoints)                           │   │
│  ├────────────────────────────────────────────────────────────┤   │
│  │  • GET  /signals          - Список сигналов               │   │
│  │  • POST /ingest-run       - Запуск сбора                  │   │
│  │  • GET  /health           - Статус системы                │   │
│  │  • GET  /dashboard        - Web UI                        │   │
│  │  • GET  /export/signals   - Экспорт (CSV/PDF)             │   │
│  │  • GET  /telegram-digest  - Telegram дайджест             │   │
│  └────────────────────────────────────────────────────────────┘   │
│                                                                      │
│  📦 Dependencies:                                                   │
│  fastapi, uvicorn, httpx, feedparser, beautifulsoup4,              │
│  pydantic, apscheduler, reportlab, pillow, aiosqlite               │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
                                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                     БАЗА ДАННЫХ (SQLite)                            │
│                         signals.db                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  📊 Таблица: signals                                                │
│  ├─ id (PRIMARY KEY)           - UUID записи                       │
│  ├─ url_hash (UNIQUE)          - Дедупликация                      │
│  ├─ title / title_ru           - Заголовки                         │
│  ├─ summary / summary_ru       - Описания                          │
│  ├─ sector, region             - Классификация                     │
│  ├─ tickers_json               - [BTC, ETH, TSLA]                  │
│  ├─ impact (0-100)             - Влияние на рынок                  │
│  ├─ confidence (0-100)         - Достоверность                     │
│  ├─ sentiment (0-100)          - Настроение                        │
│  ├─ deep_analysis_ru/en        - Глубокий анализ                   │
│  └─ ts_published, ts_ingested  - Временные метки                   │
│                                                                      │
│  📝 Таблица: ingested (временная)                                   │
│  └─ Необработанные новости до LLM анализа                          │
│                                                                      │
│  ⚙️  Оптимизация:                                                   │
│  ├─ WAL Mode (параллельное чтение/запись)                          │
│  ├─ Cache Size: 10,000 страниц                                     │
│  ├─ Busy Timeout: 30 секунд                                        │
│  └─ Synchronous: NORMAL (баланс скорости/надёжности)               │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
                    ↓                              ↓
┌──────────────────────────────────┐  ┌───────────────────────────────┐
│   GO BACKEND (Dashboard)         │  │   PYTHON API                  │
│   Port: 8090                     │  │   Port: 8080                  │
├──────────────────────────────────┤  ├───────────────────────────────┤
│                                  │  │                               │
│  🎨 Frontend Layer               │  │  📡 JSON API                  │
│  ├─ HTML Templates               │  │  ├─ /signals                 │
│  ├─ CSS (Dark Theme)             │  │  ├─ /health                  │
│  ├─ JavaScript (Vanilla)         │  │  └─ /export                  │
│  └─ i18n (RU/EN)                 │  │                               │
│                                  │  │  📱 Telegram Bot              │
│  📊 Visualization                │  │  └─ sendMessage API           │
│  ├─ Cards Grid                   │  │                               │
│  ├─ Filters                      │  │  📄 Export Engines            │
│  ├─ Search                       │  │  ├─ CSV Generator             │
│  ├─ Statistics                   │  │  └─ PDF Generator             │
│  └─ Detail Modal                 │  │                               │
│                                  │  └───────────────────────────────┘
│  ⚡ Performance                   │
│  ├─ 10x faster than Python      │
│  ├─ Compiled binary              │
│  ├─ <50ms response time          │
│  └─ Low memory (~20MB)           │
│                                  │
└──────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────────────────┐
│                         WEB BROWSER (Client)                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  🌐 Dashboard UI                                                    │
│  ├─ Фильтры (Сектор, Регион, Impact, Confidence, Sentiment)       │
│  ├─ Карточки новостей (цветовая кодировка)                         │
│  ├─ Статистика в реальном времени                                  │
│  ├─ Детальный просмотр с анализом                                  │
│  ├─ Экспорт данных (CSV/PDF)                                       │
│  └─ Переключение языка (🇷🇺/🇬🇧)                                    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 Поток данных (Data Flow)

### 1. Сбор новостей (Ingestion)

```
RSS Feed → feedparser → httpx → BeautifulSoup → SHA-256 hash
                                                       ↓
                                          [Проверка дубликатов]
                                                       ↓
                                          [Сохранение в ingested]
```

### 2. Анализ через LLM

```
ingested table → [Поиск orphans] → Batch Formation
                                          ↓
                                   [async с semaphore]
                                          ↓
                          ┌───────────────┴───────────────┐
                          ↓                               ↓
                    OpenAI API                      DeepSeek API
                          ↓                               ↓
                          └───────────────┬───────────────┘
                                          ↓
                                  [JSON Response]
                                          ↓
                            {
                              sector: "CRYPTO",
                              tickers: ["BTC"],
                              impact: 85,
                              summary_ru: "...",
                              deep_analysis_en: "..."
                            }
                                          ↓
                              [Сохранение в signals]
```

### 3. Обработка запроса пользователя

```
User Request → Browser
                 ↓
         [HTTP GET /signals?sector=CRYPTO]
                 ↓
         FastAPI Router
                 ↓
         Query Parser (filters)
                 ↓
         SQLite SELECT
                 ↓
         JSON Serialization
                 ↓
         HTTP Response
                 ↓
         Browser (Display)
```

---

## 🧩 Компоненты системы

### Backend Services

```
┌──────────────────────────────────────────────────────────────┐
│                    BACKEND SERVICES                          │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  🐍 Python Service (FastAPI)                                │
│  ├─ Port: 8080                                              │
│  ├─ Process: uvicorn app:app                                │
│  ├─ Auto-restart: Yes (launchd)                             │
│  ├─ Logs: app.log                                           │
│  └─ Functions:                                              │
│     ├─ RSS ingestion                                        │
│     ├─ LLM analysis                                         │
│     ├─ Database management                                  │
│     ├─ API endpoints                                        │
│     ├─ Telegram integration                                 │
│     └─ Export (CSV/PDF)                                     │
│                                                              │
│  🔷 Go Service (Dashboard)                                  │
│  ├─ Port: 8090                                              │
│  ├─ Process: ./signal-analysis-server                       │
│  ├─ Auto-restart: Yes (launchd)                             │
│  ├─ Logs: server.log                                        │
│  └─ Functions:                                              │
│     ├─ Web UI rendering                                     │
│     ├─ Fast API queries                                     │
│     ├─ Statistics calculation                               │
│     └─ Real-time updates                                    │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### Database Schema

```sql
-- signals table (главная таблица)
CREATE TABLE signals (
    -- Идентификация
    id TEXT PRIMARY KEY,              -- UUID
    url_hash TEXT UNIQUE,             -- SHA-256 hash URL
    body_hash TEXT,                   -- SHA-256 hash контента
    
    -- Временные метки
    ts_published TEXT,                -- ISO 8601
    ts_ingested TEXT,                 -- ISO 8601
    
    -- Источник
    source_domain TEXT,               -- example.com
    url TEXT,                         -- https://...
    
    -- Контент
    title TEXT,                       -- EN (оригинал)
    title_ru TEXT,                    -- RU (перевод)
    title_clean TEXT,                 -- Очищенный
    summary TEXT,                     -- EN краткое
    summary_ru TEXT,                  -- RU краткое
    deep_analysis_en TEXT,            -- EN полный анализ
    deep_analysis_ru TEXT,            -- RU полный анализ
    
    -- Классификация
    sector TEXT,                      -- CRYPTO, TECH, ...
    label TEXT,                       -- Метка
    region TEXT,                      -- GLOBAL, USA, ...
    
    -- Сущности (JSON arrays)
    entities_json TEXT,               -- ["Elon Musk", "Tesla"]
    tickers_json TEXT,                -- ["TSLA", "BTC"]
    
    -- Метрики (0-100)
    impact INTEGER,                   -- Влияние на рынок
    confidence INTEGER,               -- Достоверность
    sentiment INTEGER,                -- Настроение (0=негатив, 100=позитив)
    trust_score REAL DEFAULT 0.7,     -- Доверие к источнику
    
    -- Метаданные
    is_test BOOLEAN DEFAULT FALSE,
    merged_of TEXT,                   -- Объединенные записи
    providers TEXT,                   -- "openai,deepseek"
    latency TEXT DEFAULT 'fast',      -- fast/medium/slow
    raw JSON                          -- Сырые данные
);

-- Индексы для быстрого поиска
CREATE INDEX idx_sector ON signals(sector);
CREATE INDEX idx_region ON signals(region);
CREATE INDEX idx_impact ON signals(impact);
CREATE INDEX idx_ts_published ON signals(ts_published);
CREATE INDEX idx_url_hash ON signals(url_hash);
```

---

## ⚡ Производительность

### Метрики

| Операция | Время | Примечание |
|----------|-------|-----------|
| RSS фид загрузка | ~500ms | на фид |
| Дедупликация | <10ms | SHA-256 hash |
| LLM анализ (DeepSeek) | ~1s | на новость |
| LLM анализ (GPT-4) | ~3s | на новость |
| SQL INSERT | <5ms | с WAL |
| SQL SELECT | <50ms | с фильтрами |
| Dashboard загрузка | <100ms | Go backend |
| API response | <30ms | JSON |

### Оптимизации

**Python Backend:**
- ✅ Async/await для всех I/O операций
- ✅ Semaphore (limit=2) для LLM вызовов
- ✅ Connection pooling для БД
- ✅ Pipeline lock для сериализации
- ✅ Retry с exponential backoff
- ✅ Batch processing для анализа

**Go Backend:**
- ✅ Compiled binary (не интерпретируется)
- ✅ Goroutines для параллелизма
- ✅ Template caching
- ✅ Static file serving
- ✅ Минимальное использование памяти

**Database:**
- ✅ WAL mode (параллельное чтение/запись)
- ✅ Индексы на частых полях
- ✅ Cache size: 10,000 страниц
- ✅ Busy timeout: 30 секунд

---

## 🔒 Безопасность

### Layers of Security

```
┌─────────────────────────────────────────────┐
│  1. Network Layer                           │
│  ├─ Localhost only (127.0.0.1)             │
│  ├─ No external access                      │
│  └─ Firewall ready                          │
├─────────────────────────────────────────────┤
│  2. Application Layer                       │
│  ├─ API ключи в .env (не в коде)          │
│  ├─ SQL injection protection (Pydantic)     │
│  ├─ Rate limiting (semaphore)               │
│  └─ Input validation                        │
├─────────────────────────────────────────────┤
│  3. Database Layer                          │
│  ├─ Prepared statements                     │
│  ├─ Transaction isolation                   │
│  ├─ WAL для целостности                     │
│  └─ Timeout protection                      │
├─────────────────────────────────────────────┤
│  4. Monitoring Layer                        │
│  ├─ Детальное логирование                   │
│  ├─ Error tracking                          │
│  ├─ Health checks                           │
│  └─ Alert system (можно добавить)          │
└─────────────────────────────────────────────┘
```

### Best Practices

- ✅ Никаких паролей в коде
- ✅ .env файл в .gitignore
- ✅ API ключи через переменные окружения
- ✅ HTTPS для production (через nginx)
- ✅ Регулярные обновления зависимостей
- ✅ Логирование всех операций

---

## 📊 Масштабируемость

### Текущие ограничения

| Параметр | Значение | Можно увеличить |
|----------|----------|-----------------|
| RSS фидов | 9 активных | До 50+ |
| Новостей/час | ~90 | До 500+ |
| Параллельных LLM | 2 | До 10+ |
| Размер БД | ~50 MB | До 10+ GB |
| Concurrent users | 1-5 | До 100+ |

### Масштабирование

**Horizontal Scaling:**
```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  Worker 1   │  │  Worker 2   │  │  Worker 3   │
│  (Python)   │  │  (Python)   │  │  (Python)   │
└──────┬──────┘  └──────┬──────┘  └──────┬──────┘
       │                │                │
       └────────────────┴────────────────┘
                        ↓
               ┌─────────────────┐
               │  Load Balancer  │
               │  (nginx)        │
               └────────┬────────┘
                        ↓
               ┌─────────────────┐
               │  PostgreSQL     │
               │  (вместо SQLite)│
               └─────────────────┘
```

**Vertical Scaling:**
- Увеличить semaphore limit (больше параллельных LLM)
- Увеличить количество новостей на фид
- Уменьшить интервал обновления
- Добавить Redis для кэширования

---

## 🔄 Жизненный цикл данных

```
┌──────────────────────────────────────────────────────────────┐
│                   DATA LIFECYCLE                             │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  1️⃣  BIRTH (Рождение)                                        │
│     RSS Feed → Parser → ingested table                      │
│     Статус: raw, unprocessed                                │
│     Lifetime: до анализа LLM                                │
│                                                              │
│  2️⃣  ANALYSIS (Анализ)                                       │
│     ingested → LLM → signals table                          │
│     Статус: analyzed, enriched                              │
│     Добавлено: sector, tickers, metrics, translations       │
│                                                              │
│  3️⃣  STORAGE (Хранение)                                      │
│     signals table                                           │
│     Статус: persisted                                       │
│     Индексы: sector, impact, ts_published                   │
│                                                              │
│  4️⃣  SERVING (Отдача)                                        │
│     API → JSON → Browser                                    │
│     Фильтрация, сортировка, пагинация                       │
│     Форматы: JSON, CSV, PDF                                 │
│                                                              │
│  5️⃣  ARCHIVING (Архивирование, опционально)                 │
│     signals → archive table (после N дней)                  │
│     Очистка старых записей                                  │
│     Backup → S3/другое хранилище                            │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## 🎯 Ключевые паттерны

### 1. Pipeline Pattern

```python
async def run_pipeline():
    """Последовательная обработка данных"""
    async with pipeline_lock:
        data = await ingest()      # Шаг 1
        enriched = await analyze(data)  # Шаг 2
        await save(enriched)       # Шаг 3
        await notify()             # Шаг 4
```

### 2. Retry Pattern

```python
@retry(stop=stop_after_attempt(3), wait=wait_exponential())
async def call_llm_with_retry():
    """Повторные попытки при ошибках"""
    return await llm_api_call()
```

### 3. Semaphore Pattern

```python
semaphore = asyncio.Semaphore(2)

async def limited_call():
    """Ограничение параллельных вызовов"""
    async with semaphore:
        return await expensive_operation()
```

### 4. Repository Pattern

```python
class SignalRepository:
    def find_by_sector(self, sector: str):
        """Абстракция работы с БД"""
        pass
```

---

## 📚 Технологические решения

### Почему FastAPI?

✅ Async/await из коробки  
✅ Автоматическая валидация (Pydantic)  
✅ Встроенная документация (Swagger)  
✅ Высокая производительность  
✅ Современный Python 3.10+  

### Почему SQLite?

✅ Нет необходимости в отдельном сервере  
✅ Файловая БД (простое развертывание)  
✅ WAL mode (параллельное чтение/запись)  
✅ Достаточно для миллионов записей  
✅ Легкое резервное копирование (просто скопировать файл)  

### Почему Go для Dashboard?

✅ 10x быстрее Python  
✅ Compiled binary (один файл)  
✅ Низкое потребление памяти  
✅ Отличная производительность  
✅ Простое развертывание  

---

**🏗️ Архитектура спроектирована для**:
- ✅ Высокой производительности
- ✅ Простоты развертывания
- ✅ Легкого масштабирования
- ✅ Надежности и стабильности
- ✅ Простоты поддержки

---

**Версия**: 1.5.0  
**Последнее обновление**: 6 ноября 2025

