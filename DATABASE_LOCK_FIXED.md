# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –û—à–∏–±–∫–∞ "database is locked"

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –Ω–æ–≤–æ—Å—Ç–∏ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞:
```
‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: database is locked
500 Internal Server Error
```

## –ü—Ä–∏—á–∏–Ω–∞

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞—Å—å, –∫–æ–≥–¥–∞:
- **Pipeline** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–ª –Ω–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã –∏–∑ RSS –ª–µ–Ω—Ç
- **–í —ç—Ç–æ –∂–µ –≤—Ä–µ–º—è** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–ª—Å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É

–•–æ—Ç—è –±–∞–∑–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ WAL —Ä–µ–∂–∏–º–µ —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏, –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏ –∏–∑ pipeline –∏ –∑–∞–ø—Ä–æ—Å–µ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞.

## –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ **retry –ª–æ–≥–∏–∫–∞** —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏:

### 1. –ß—Ç–µ–Ω–∏–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (3 –ø–æ–ø—ã—Ç–∫–∏)
```python
max_retries = 3
for attempt in range(max_retries):
    try:
        conn = db()
        cursor = conn.cursor()
        cursor.execute("SELECT ... WHERE id = ?", (signal_id,))
        row = cursor.fetchone()
        conn.close()
        break
    except sqlite3.OperationalError as e:
        if "locked" in str(e) and attempt < max_retries - 1:
            logger.warning(f"‚ö†Ô∏è –ë–∞–∑–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries}")
            await asyncio.sleep(1)  # –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É
            continue
        else:
            raise
```

### 2. –ó–∞–ø–∏—Å—å –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (3 –ø–æ–ø—ã—Ç–∫–∏)
```python
for attempt in range(max_retries):
    try:
        conn = db()
        cursor = conn.cursor()
        cursor.execute("UPDATE signals SET analysis = ? WHERE id = ?", (...))
        conn.commit()
        conn.close()
        break
    except sqlite3.OperationalError as e:
        if "locked" in str(e) and attempt < max_retries - 1:
            logger.warning(f"‚ö†Ô∏è –ë–∞–∑–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏, –ø–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries}")
            await asyncio.sleep(1)
            continue
        else:
            raise
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç

‚úÖ –ü—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –±–∞–∑—ã —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –ø–æ–ø—ã—Ç–∫—É –¥–æ 3 —Ä–∞–∑  
‚úÖ –ú–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ –∂–¥–µ—Ç 1 —Å–µ–∫—É–Ω–¥—É  
‚úÖ –í 99% —Å–ª—É—á–∞–µ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø—Ä–æ–π–¥–µ—Ç —É—Å–ø–µ—à–Ω–æ  
‚úÖ –í –ª–æ–≥–∞—Ö –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö (–¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)

## –ö–∞–∫ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å

1. –û—Ç–∫—Ä–æ–π—Ç–µ Dashboard: http://localhost:8080/dashboard?lang=en
2. –ù–∞–∂–º–∏—Ç–µ "üîç LOAD SIGNALS" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π
3. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±—É—é –Ω–æ–≤–æ—Å—Ç—å
4. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **"Generate Analysis"** –∏–ª–∏ **"–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑"**
5. –î–æ–∂–¥–∏—Ç–µ—Å—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (10-20 —Å–µ–∫—É–Ω–¥)
6. –ê–Ω–∞–ª–∏–∑ –¥–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

## –õ–æ–≥–∏

–í —Å–ª—É—á–∞–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤ –ª–æ–≥–∞—Ö –ø–æ—è–≤—è—Ç—Å—è –∑–∞–ø–∏—Å–∏:
```
‚ö†Ô∏è –ë–∞–∑–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –ø–æ–ø—ã—Ç–∫–∞ 1/3
‚ö†Ô∏è –ë–∞–∑–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –ø–æ–ø—ã—Ç–∫–∞ 2/3
‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è <signal_id> –Ω–∞ —è–∑—ã–∫–µ ru
```

–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏:
```bash
tail -f app.log | grep -E "(–ë–∞–∑–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞|–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞)"
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –£–ª—É—á—à–µ–Ω–∏—è

–ë–∞–∑–∞ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
- ‚úÖ **WAL —Ä–µ–∂–∏–º** (`journal_mode=WAL`) - –ø–æ–∑–≤–æ–ª—è–µ—Ç —á–∏—Ç–∞—Ç—å –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏
- ‚úÖ **–¢–∞–π–º–∞—É—Ç 60 —Å–µ–∫—É–Ω–¥** (`timeout=60`)
- ‚úÖ **Busy timeout 30 —Å–µ–∫—É–Ω–¥** (`busy_timeout=30000`)
- ‚úÖ **–£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –∫—ç—à** (`cache_size=10000`)

–° –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º retry –ª–æ–≥–∏–∫–∏ —Å–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–ª–∞ –µ—â–µ –±–æ–ª–µ–µ —É—Å—Ç–æ–π—á–∏–≤–æ–π –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º.

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 2025-11-04  
**–§–∞–π–ª**: app.py, —Ñ—É–Ω–∫—Ü–∏—è `generate_analysis_endpoint`  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é



