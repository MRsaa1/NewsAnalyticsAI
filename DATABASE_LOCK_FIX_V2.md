# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã "Database is locked" –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É **"–ê–Ω–∞–ª–∏–∑"** –≤ Dashboard –ø–æ—è–≤–ª—è–ª–∞—Å—å –æ—à–∏–±–∫–∞:

```
‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: 500
ERROR: database is locked
```

---

## üîç –ü—Ä–∏—á–∏–Ω–∞

SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –±—ã–ª–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
- **–ü–∞–π–ø–ª–∞–π–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ** (—Å–±–æ—Ä –Ω–æ–≤–æ—Å—Ç–µ–π –∫–∞–∂–¥—ã–π —á–∞—Å)
- **WAL —Ä–µ–∂–∏–º** –Ω–µ –≤—Å–µ–≥–¥–∞ –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–∏ UPDATE –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
- **–ö–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–π–º–∞—É—Ç—ã** (timeout=60 —Å–µ–∫—É–Ω–¥)
- **–ú–∞–ª–æ –ø–æ–ø—ã—Ç–æ–∫ retry** (—Ç–æ–ª—å–∫–æ 3)

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ –≤ `app.py`:

#### 1. –£–≤–µ–ª–∏—á–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã SQLite

```python
# –ë—ã–ª–æ:
conn = db()  # timeout=60

# –°—Ç–∞–ª–æ:
conn = sqlite3.connect(DB_PATH, timeout=90, check_same_thread=False)
conn.execute("PRAGMA busy_timeout=60000;")  # 60 —Å–µ–∫—É–Ω–¥ –æ–∂–∏–¥–∞–Ω–∏—è
```

#### 2. –£–≤–µ–ª–∏—á–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ retry

```python
# –ë—ã–ª–æ:
max_retries = 3

# –°—Ç–∞–ª–æ:
max_retries = 5  # 5 –ø–æ–ø—ã—Ç–æ–∫ –≤–º–µ—Å—Ç–æ 3
```

#### 3. –£–≤–µ–ª–∏—á–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏

```python
# –ë—ã–ª–æ:
await asyncio.sleep(1)  # 1 —Å–µ–∫—É–Ω–¥–∞

# –°—Ç–∞–ª–æ (—á—Ç–µ–Ω–∏–µ):
await asyncio.sleep(2)  # 2 —Å–µ–∫—É–Ω–¥—ã

# –°—Ç–∞–ª–æ (–∑–∞–ø–∏—Å—å):
await asyncio.sleep(3)  # 3 —Å–µ–∫—É–Ω–¥—ã
```

#### 4. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

```python
# –¢–µ–ø–µ—Ä—å –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î - 
# –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
if not saved:
    logger.warning("‚ö†Ô∏è –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –ë–î")
    
return {"analysis": analysis_text}  # –í—Å–µ —Ä–∞–≤–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
```

#### 5. –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

```python
# –í—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ finally –±–ª–æ–∫–µ
if conn:
    try:
        conn.close()
    except:
        pass
```

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```
‚ùå –û—à–∏–±–∫–∞ 500 –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ "–ê–Ω–∞–ª–∏–∑"
‚ùå database is locked
‚ùå –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```
‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úÖ –î–æ 5 –ø–æ–ø—ã—Ç–æ–∫ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º–∏ —Ç–∞–π–º–∞—É—Ç–∞–º–∏
‚úÖ –û–∂–∏–¥–∞–Ω–∏–µ –¥–æ 60 —Å–µ–∫—É–Ω–¥ –Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∞—Å—å –≤ –ë–î
‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
```

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

1. –û—Ç–∫—Ä–æ–π—Ç–µ Dashboard: http://localhost:8080/dashboard?lang=en
2. –í—ã–±–µ—Ä–∏—Ç–µ –ª—é–±—É—é –Ω–æ–≤–æ—Å—Ç—å
3. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É **"–ê–Ω–∞–ª–∏–∑"**
4. –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:
   ```
   ‚è≥ Generating analytics...
   ```
5. –ß–µ—Ä–µ–∑ 5-10 —Å–µ–∫—É–Ω–¥ –ø–æ—è–≤–∏—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
6. –ë–µ–∑ –æ—à–∏–±–∫–∏ 500!

---

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í `app.log` —Ç–µ–ø–µ—Ä—å –≤–∏–¥–Ω–æ:

```bash
# –ï—Å–ª–∏ –µ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç):
‚ö†Ô∏è –ë–∞–∑–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞, –ø–æ–ø—ã—Ç–∫–∞ 1/5, –∂–¥—É 2 —Å–µ–∫...
‚ö†Ô∏è –ë–∞–∑–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏, –ø–æ–ø—ã—Ç–∫–∞ 2/5, –∂–¥—É 3 —Å–µ–∫...
‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –ë–î –¥–ª—è abc123...

# –£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è:
üîç –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–ª—è abc123 –Ω–∞ —è–∑—ã–∫–µ en
‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è abc123 –Ω–∞ —è–∑—ã–∫–µ en
```

---

## ‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã retry

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –≠—Ñ—Ñ–µ–∫—Ç |
|----------|------|-------|--------|
| Max retries | 3 | 5 | –ë–æ–ª—å—à–µ –ø–æ–ø—ã—Ç–æ–∫ |
| Timeout | 60s | 90s | –î–æ–ª—å—à–µ –∂–¥–µ–º |
| Busy timeout | 30s | 60s | 2x –¥–æ–ª—å—à–µ |
| Sleep (read) | 1s | 2s | –ë–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ |
| Sleep (write) | 1s | 3s | –ï—â–µ –±–æ–ª—å—à–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ |

**–ò—Ç–æ–≥–æ**: –î–æ 5 –ø–æ–ø—ã—Ç–æ–∫ √ó 3 —Å–µ–∫—É–Ω–¥—ã –æ–∂–∏–¥–∞–Ω–∏—è = –¥–æ 15 —Å–µ–∫—É–Ω–¥ –Ω–∞ retry

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –≤—Å–µ –µ—â–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç:

#### –í–∞—Ä–∏–∞–Ω—Ç 1: –£–≤–µ–ª–∏—á–∏—Ç—å –µ—â–µ —Ç–∞–π–º–∞—É—Ç—ã

```python
# app.py, —Å—Ç—Ä–æ–∫–∞ 2108
conn = sqlite3.connect(DB_PATH, timeout=120, check_same_thread=False)
conn.execute("PRAGMA busy_timeout=90000;")  # 90 —Å–µ–∫—É–Ω–¥
```

#### –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

```python
# –°–æ–∑–¥–∞—Ç—å read-only —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è —á—Ç–µ–Ω–∏—è
conn = sqlite3.connect(f"file:{DB_PATH}?mode=ro", uri=True, timeout=90)
```

#### –í–∞—Ä–∏–∞–Ω—Ç 3: –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å

```python
# –í–µ—Ä–Ω—É—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ä–∞–∑—É, –∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ–∑–∂–µ
asyncio.create_task(save_analysis_later(signal_id, analysis_text))
return {"analysis": analysis_text}
```

---

## üöÄ –°—Ç–∞—Ç—É—Å

‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ**  
‚úÖ **–°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω** (PID: 56645)  
‚úÖ **–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é**  

---

## üìä –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

**–§–∞–π–ª**: `app.py`  
**Endpoint**: `POST /generate-analysis/{signal_id}`  
**–°—Ç—Ä–æ–∫–∏**: 2095-2270  
**–ò–∑–º–µ–Ω–µ–Ω–æ**: ~40 —Å—Ç—Ä–æ–∫  

---

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: 7 –Ω–æ—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è**: 1.6.1

